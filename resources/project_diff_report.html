<html lang="en">
<head>
    <title>{{title}}</title>

    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/datatables.min.css"/>

    <script src="js/jquery-3.2.1.slim.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <script type="text/javascript" src="js/datatables.min.js"></script>
    <!-- This is generated -->
    <script type="text/javascript" src="project_data.js"></script>

    <link rel="stylesheet" href="css/maven-theme.css">
</head>
<body>
<div class="section">
    <h2>Summary</h2>
    <div class="section-content">
        <table id="table-summary" class="table">
            <thead>
            <tr>
                <th></th>
                <th>Base</th>
                <th>Patch</th>
                <th>Difference</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td class="item"><a href="#section-violations">Violations</a>
                </td>
                <td class="base">{{diff.base_violations_size}}</td>
                <td class="patch">{{diff.patch_violations_size}}</td>
                <td class="diff">
                    <span class="pill badge-pill badge-secondary removed">-{{diff.removed_violations_size}}</span>
                    <span class="pill badge-pill badge-secondary changed">~{{diff.changed_violations_size}}</span>
                    <span class="pill badge-pill badge-secondary added">+{{diff.new_violations_size}}</span>
                </td>
            </tr>
            <tr>
                <td class="item"><a href="#section-errors">Errors</a></td>
                <td class="base">{{diff.base_errors_size}}</td>
                <td class="patch">{{diff.patch_errors_size}}</td>
                <td class="diff">
                    <span class="pill badge-pill badge-secondary removed">-{{diff.removed_errors_size}}</span>
                    <span class="pill badge-pill badge-secondary changed">~{{diff.changed_errors_size}}</span>
                    <span class="pill badge-pill badge-secondary added">+{{diff.new_errors_size}}</span>
                </td>
            </tr>
            <tr>
                <td class="item"><a href="#section-configerrors">Config
                    errors</a></td>
                <td class="base">{{diff.base_configerrors_size}}</td>
                <td class="patch">{{diff.patch_configerrors_size}}</td>
                <td class="diff">
                    <span class="pill badge-pill badge-secondary removed">-{{diff.removed_configerrors_size}}</span>
                    <span class="pill badge-pill badge-secondary added">+{{diff.new_configerrors_size}}</span>
                </td>
            </tr>
            <tr>
                <td class="item">Execution time</td>
                <td class="base">{{diff.base_execution_time}}</td>
                <td class="patch">{{diff.patch_execution_time}}</td>
                <td class="diff">{{diff.diff_execution_time}}</td>
            </tr>
            <tr>
                <td class="item">Timestamp</td>
                <td class="base">{{diff.base_timestamp}}</td>
                <td class="patch">{{diff.patch_timestamp}}</td>
                <td class="diff"></td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="section" id="section-rule-summary">

    <h2>Summary by rule</h2>

    <div class="section-content">

        <div class="table-responsive">
            <table id="rule-summary" class="table">
                <thead>
                <tr>
                    <th>Rule</th>
                    <th>Base</th>
                    <th>Patch</th>
                    <th>Added</th>
                    <th>Changed</th>
                    <th>Removed</th>
                </tr>
                </thead>
                <tbody>

                {% assign sorted_rule_diffs = diff.rule_diffs | sort: 'name' %}

                {% for rule_diff in sorted_rule_diffs %}
                <tr id="rule-summary-{{rule_diff.name}}">
                    <td class="rulename">
                        {{ rule_diff.name }}
                        <span class="rule-doc-link"><a class="rulelink" href="{{rule_diff.info_url}}" target="_blank" rel="noopener noreferrer">[doc]</a></span>
                    </td>
                    <td class="basecount">{{ rule_diff.base_count }}</td>
                    <td class="patchcount">{{ rule_diff.patch_count }}</td>
                    <td class="added" data-count="{{ rule_diff.added }}">{{ rule_diff.added }}</td>
                    <td class="changed" data-count="{{ rule_diff.changed }}">{{ rule_diff.changed }}</td>
                    <td class="removed" data-count="{{ rule_diff.removed }}">{{ rule_diff.removed }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<div class="section" id="section-violations">

    <h2>Violations</h2>

    <div class="section-content">

        <table id="violationsTable" width="100%" class="table">
            <thead>
            <tr>
                <th>Location</th>
                <th>Rule</th>
                <th>Message</th>
                <th>Type</th>
            </tr>
            </thead>
        </table>

    </div>
</div>

<div class="section" id="section-errors">

    <h2>Errors</h2>

    <div class="section-content">

        <div class="table-responsive">
            <table id="error-table" class="table">
                <thead>
                 <tr>
                     <th>File</th>
                     <th>Description (click to expand)</th>
                 </tr>
                </thead>
                <tbody>
                {% for error in error_diffs %}
                <tr id="error-{{forloop.index}}" class="accordion-toggle error-row {{error.change_type}}" data-toggle="collapse" data-target="#error-{{forloop.index}}-expanded">
                    <td><a href="{{error.file_url}}"  target="_blank" rel="noopener noreferrer">{{error.short_filename}}</a></td>
                    <td>{{error.short_message | escape | replace: error.filename, "<span class='meta-var'>$FILE</span>" }}</td>
                </tr>
                <tr>
                    <td class="row-hidden" colspan="2">
                        <div class="accordion-body collapse" id="error-{{forloop.index}}-expanded">
                            <div class="collapsed-content-padder">
                                <pre>
{{ error.stack_trace_html }}
                                </pre>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
</div>

<script type="text/javascript">

    function makeCodeLink(violation) {
        let template = project.source_link_template
        template = template.replace('{file}', violation.f)
        return template.replace('{line}', violation.l)
    }

    function extractFilename(path) {
        const pathArray = path.split("/");
        return pathArray[pathArray.length - 1];
    }

    const cssClass = {
        "+": "added",
        "-": "removed",
        "~": "changed",
    }

    const typeDisplay = {
        "+": "Added",
        "-": "Removed",
        "~": "Changed",
    }

    $(document).ready(function () {
        $('#violationsTable').DataTable({
            data: project.violations,
            columns: [
                // other attributes:
                // l: line
                // ol: old line
                {"data": "f"}, // file
                {"data": "r"}, // rule
                {"data": "m"}, // message
                {"data": "t"}, // type
            ],
            deferRender: true,
            // scrollY: "6000px",
            dom: 'Pfrtip',
            searchPanes: {
                viewTotal: true,
                cascadePanes: true,
                columns: [0, 1, 3],
                order: ['Rule', 'Location', 'Type']
            },
            // scrollCollapse: true,
            // paging: false,
            columnDefs: [
                { //file column
                    render(data, type, row) {
                        data = project.file_index[data]
                        // display only the file name (not full path), but use full
                        // path for sorting and such
                        if (type === "display") {
                            let line = 'ol' in row ? row.ol + " -> " + row.l : row.l;
                            //note : target='_blank' requires that the link open in a new tab
                            return "<a href='" + makeCodeLink(row) + "' target='_blank' rel='noopener noreferrer'>" + extractFilename(data) + " @ line " + line + "</a>"
                        } else if (type === "sort") {
                            return data + "#" + row.line
                        } else if (type === 'shortFile') {
                            return extractFilename(data)
                        } else {
                            return data;
                        }
                    },
                    searchPanes :{
                        orthogonal: {
                            'display': 'shortFile',
                            'search':  undefined
                        }
                    },
                    targets: 0
                },
                { // rule column
                    render(data, type, row) {
                        // display only the file name (not full path), but use full
                        // path for sorting and such
                        if (type === "display")
                            return "<a href='#rule-summary-" + data + "'>" + data + "</a>"
                        else
                            return data;
                    },
                    searchPanes: {
                        orthogonal: {
                            'display' : 'sort' // do not use the display, which is an <a>
                        }
                    },
                    targets: 1
                },
                { // type column
                    visible: false,
                    render(data, type, row) {
                        return type ==='display' ? typeDisplay[data] : cssClass[data]
                    },
                    targets: 3
                },
            ],
            displayLength: 50,
            rowCallback(row, data, index) {
                $(row).addClass(cssClass[data.t]);
            },
        });

    });
</script>

</body>
</html>
